[{"categories":null,"content":" æå®¢æ—¶é—´-https://time.geekbang.org/column/article/595683\nå¼€ç¯‡ é«˜å¹¶å‘ç³»ç»Ÿç†Ÿæ‚‰åˆé™Œç”Ÿï¼Œå¸¸ç”¨åˆ°çš„æœåŠ¡ï¼šæ·˜å®ã€å¾®åšã€ç¾å›¢ã€12306\nä¸ºä»€ä¹ˆç™¾ä¸‡å¹¶å‘ç³»ç»Ÿä¸èƒ½ç›´æ¥ä½¿ç”¨ MySQL æœåŠ¡ï¼Ÿ ä¸ºä»€ä¹ˆ Redis å†…å­˜ç›¸æ¯”ç£ç›˜ï¼Œéœ€è¦ç”¨æ›´å¤šçš„ç©ºé—´ï¼Ÿ æ€ä¹ˆä¿è¯æ¡ä»¶æŸ¥è¯¢ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ ä¸ºä»€ä¹ˆé«˜çº§è¯­è¨€ä¸èƒ½ç›´æ¥åšä¸šåŠ¡ç¼“å­˜æœåŠ¡ï¼Ÿ\nä¸Šé¢æåˆ°çš„ä¸ºä»€ä¹ˆç™¾ä¸‡å¹¶å‘ä¸èƒ½ç›´æ¥ä½¿ç”¨ MySQL æœåŠ¡ï¼Œæˆ‘å¤§æ¦‚èƒ½å›ç­”å‡ºæ¥çš„å°±æ˜¯å› ä¸ºå¤ªé«˜çš„å¹¶å‘æŸ¥è¯¢ä¼šå¯¼è‡´ MySQL ç¼“æ…¢ï¼Œç„¶åç®€å•åœ°è®²è®²å¦‚ä½•ç”¨ç¼“å­˜æŠµæŒ¡æµé‡ğŸ˜…è¦äº†è§£ä¸€ä¸‹ åˆ†å¸ƒå¼æ•°æ®åº“ç´¢å¼•ã€å­˜å‚¨ã€æ•°æ®åˆ†ç‰‡ã€å­˜å‚¨åˆ†ç¦»ç­‰ç›¸å…³çŸ¥è¯†ã€‚\näº’è”ç½‘æœåŠ¡çš„æ ¸å¿ƒä»·å€¼å°±æ˜¯æµé‡ï¼Œæµé‡è¶Šå¤§ï¼Œå¹³å°çš„å¯èƒ½æ€§å’Œç©ºé—´å°±è¶Šå¤§ã€‚\nå¦‚æœæ”¹é€ é«˜å¹¶å‘ç³»ç»Ÿï¼š è¯†åˆ«ç³»ç»Ÿç±»å‹ã€å®Œå–„ç›‘æ§ç³»ç»Ÿã€æ¢³ç†æ”¹é€ è¦ç‚¹ã€å°æ­¥æ”¹é€ è®¤è¯\nè¯†åˆ«ç³»ç»Ÿç±»å‹ æŒ‰æ•°æ®ç‰¹å¾ç»™ç³»ç»Ÿåˆ†ç±»ï¼šè¯»å¤šå†™å°‘ã€å¼ºä¸€è‡´æ€§ã€å†™å¤šè¯»å°‘ã€è¯»å¤šå†™å¤š\nè¯»å¤šå†™å°‘ ç”¨æˆ·ä¸­å¿ƒï¼Œè¿™ç±»ç³»ç»Ÿçš„ä¼˜åŒ–å·¥ä½œä¼šèšç„¦äºå¦‚ä½•é€šè¿‡ç¼“å­˜åˆ†æ‹…æ•°æ®åº“æŸ¥è¯¢å‹åŠ›ï¼Œåšå¥½ç¼“å­˜ï¼ŒåŠ ç¼“å­˜åï¼Œä¸»ä»åŒæ­¥å»¶è¿Ÿã€å¤šæœºæˆ¿åŒæ­¥ç­‰ä¿è¯æ•°æ®ä¸€è‡´æ€§\nå¼ºä¸€è‡´æ€§ ç”µå•†ç³»ç»Ÿï¼Œä¸»è¦æŒ‘æˆ˜æ˜¯æ‰¿æ¥é«˜å¹¶å‘æµé‡çš„åŒæ—¶ï¼Œè¿˜è¦åšå¥½ç³»ç»Ÿéš”ç¦»æ€§ã€äº‹åŠ¡ä¸€è‡´æ€§ä»¥åŠåº“å­˜é«˜å¹¶å‘äº‰æŠ¢ä¸è¶…å–ã€‚ç³»ç»Ÿéš”ç¦»ã€åŒæ­¥é™çº§å’Œåº“å­˜é”ç­‰ç›¸å…³å†…å®¹çš„è®¤è¯†ï¼Œå¼„æ˜ç™½åˆ†å¸ƒå¼äº‹åŠ¡ç»„ä»¶çš„è¿ä½œè§„å¾‹ã€‚\nå†™å¤šè¯»å°‘ é«˜å¹¶å‘ å†™ç³»ç»Ÿï¼Œå…¨é‡æ—¥å¿—åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªç³»ç»Ÿã€‚æ¶‰åŠå¤§é‡æ•°æ®å¦‚ä½•è½ç›˜ã€å¦‚ä½•ä¼ è¾“ã€å­˜å‚¨ã€å‹ç¼©ï¼Œè¿˜æœ‰å†·çƒ­æ•°æ®çš„åˆ‡æ¢å¤‡ä»½ã€ç´¢å¼•æŸ¥è¯¢ç­‰å¤šæ–¹é¢é—®é¢˜ã€‚\nè¯»å¤šå†™å¤š æ¸¸æˆã€ç›´æ’­æœåŠ¡ï¼Œæœ€å¤æ‚çš„ç³»ç»Ÿç±»å‹ï¼Œçº¿ä¸Šç¨å¾®æœ‰ç‚¹é—®é¢˜ï¼Œéƒ½æå…¶å½±å“ç”¨æˆ·ä½“éªŒã€‚è¿™ç±»ç³»ç»Ÿæ•°æ®åŸºæœ¬éƒ½æ˜¯åœ¨å†…å­˜ä¸­ç›´æ¥å¯¹å¤–æœåŠ¡ï¼ŒåŒæ—¶æœåŠ¡éƒ½è¦æ‹†æˆå¾ˆå°çš„å•å…ƒï¼Œæ•°æ®æ˜¯å‘¨æœŸè½åˆ°ç£ç›˜æˆ–æ•°æ®åº“ï¼Œè€Œä¸æ˜¯å®æ—¶æ›´æ–°åˆ°æ•°æ®åº“ã€‚å› æ­¤æˆ‘ä»¬çš„å­¦ä¹ é‡ç‚¹æ˜¯å¦‚ä½•ç”¨å†…å­˜æ•°æ®åšä¸šåŠ¡æœåŠ¡ã€ç³»ç»Ÿæ— éœ€é‡å¯çƒ­æ›´æ–°ã€è„šæœ¬å¼•æ“é›†æˆã€è„šæœ¬ä¸æœåŠ¡äº’åŠ¨äº¤æ¢æ•°æ®ã€ç›´æ’­åœºæ™¯é«˜å¹¶å‘ä¼˜åŒ–ã€ä¸€äº›å…³äºç½‘ç»œä¼˜åŒ– CDN å’Œ DNSã€çŸ¥è¯†ä»¥åŠä¸šåŠ¡æµé‡è°ƒåº¦ã€å®¢æˆ·ç«¯æœ¬åœ°ç¼“å­˜ç­‰ç›¸å…³çŸ¥è¯†ã€‚\n","description":"","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿ-ç¬”è®°","uri":"/posts/highconcurrentsystem/"},{"categories":null,"content":"åŸºæœ¬çš„åºåˆ—åŒ– é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Goè¯­è¨€ä¸­json.Marshalï¼ˆåºåˆ—åŒ–ï¼‰ä¸json.Unmarshalï¼ˆååºåˆ—åŒ–ï¼‰çš„åŸºæœ¬ç”¨æ³•ã€‚\nå¿½ç•¥æ²¡æœ‰å€¼çš„å­—æ®µ omitempty\næŒ‡å®šjsonåºåˆ—åŒ–/ååºåˆ—åŒ–æ—¶å¿½ç•¥æ­¤å­—æ®µ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 type Person struct { Name string `json:\"name\"` // æŒ‡å®šjsonåºåˆ—åŒ–/ååºåˆ—åŒ–æ—¶ä½¿ç”¨å°å†™name Age int64 `json:\"age,omitempty\"` //å¦‚æœæƒ³è¦åœ¨åºåˆ—åºåˆ—åŒ–æ—¶å¿½ç•¥è¿™äº›æ²¡æœ‰å€¼çš„å­—æ®µæ—¶ï¼Œå¯ä»¥åœ¨å¯¹åº”å­—æ®µæ·»åŠ omitempty tagã€‚ Weight float64 `json:\"-\"` // æŒ‡å®šjsonåºåˆ—åŒ–/ååºåˆ—åŒ–æ—¶å¿½ç•¥æ­¤å­—æ®µ } func main1() { p1 := Person{ Name: \"67in\", Age: 18, Weight: 50, } //struct -\u003e json string b, err := json.Marshal(p1) if err != nil { fmt.Println(\"json.Marshal failed, err:%v\\n\", err) return } fmt.Println(b) fmt.Printf(\"str:%s\\n\", b) //json string -\u003e struct var p2 Person err = json.Unmarshal(b, \u0026p2) if err != nil { fmt.Printf(\"json.UnMarshal failed, err:%v\\n\", err) return } fmt.Println(p2) fmt.Printf(\"p2:%v\\n\", p2) fmt.Printf(\"p2:%#v\\n\", p2) } å¿½ç•¥åµŒå¥—ç»“æ„ä½“ç©ºå€¼å­—æ®µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 type User struct { Name string `json:\"name\"` Email string `json:\",omitempty\"` Hobby []string `json:\"hobby,omitempty\"` Profile } type Profile struct { Website string `json:\"site\"` Slogan string `json:\"slogan\"` } func main2() { u1 := User1{ Name: \"67in\", Hobby: []string{\"è¶³çƒ\", \"åŒè‰²çƒ\"}, } b, err := json.Marshal(u1) if err != nil { fmt.Printf(\"json.Marshal failed, err:%v\\n\", err) return } fmt.Printf(\"str:%s\\n\", b) } //åŒ¿ååµŒå¥—Profileæ—¶åºåˆ—åŒ–åçš„jsonä¸²ä¸ºå•å±‚çš„ //è¾“å‡º str:{\"name\":\"ä¸ƒç±³\",\"hobby\":[\"è¶³çƒ\",\"åŒè‰²çƒ\"],\"site\":\"\",\"slogan\":\"\"} //æƒ³è¦å˜æˆåµŒå¥—çš„jsonä¸²ï¼Œéœ€è¦æ”¹ä¸ºå…·ååµŒå¥—æˆ–å®šä¹‰å­—æ®µtagï¼š type User1 struct { Name string `json:\"name\"` Email string `json:\"email,omitempty\"` Hobby []string `json:\"hobby,omitempty\"` Profile `json:\"profile\"` } //è¾“å‡º str:{\"name\":\"ä¸ƒç±³\",\"hobby\":[\"è¶³çƒ\",\"åŒè‰²çƒ\"],\"profile\":{\"site\":\"\",\"slogan\":\"\"}} //æƒ³è¦åœ¨åµŒå¥—çš„ç»“æ„ä½“ä¸ºç©ºå€¼æ—¶ï¼Œå¿½ç•¥è¯¥å­—æ®µï¼Œä»…åœ¨profileå­—æ®µæ·»åŠ omitemptyæ˜¯ä¸å¤Ÿçš„ type User2 struct { Name string `json:\"name\"` Email string `json:\"email,omitempty\"` Hobby []string `json:\"hobby,omitempty\"` Profile `json:\"profile,omitempty\"` } //è¾“å‡º str:{\"name\":\"ä¸ƒç±³\",\"hobby\":[\"è¶³çƒ\",\"åŒè‰²çƒ\"],\"profile\":{\"site\":\"\",\"slogan\":\"\"}} //æ­¤æ—¶å¹¶æ²¡æœ‰å¿½ç•¥ï¼Œéœ€è¦ä½¿ç”¨åµŒå¥—çš„ç»“æ„ä½“æŒ‡é’ˆ type User3 struct { Name string `json:\"name\"` Email string `json:\"email,omitempty\"` Hobby []string `json:\"hobby,omitempty\"` *Profile `json:\"profile,omitempty\"` } ä¸ä¿®æ”¹åŸç»“æ„ä½“å¿½ç•¥æŸå­—æ®µ éœ€è¦jsonåºåˆ—åŒ–Userï¼Œä½†æ˜¯ä¸æƒ³æŠŠå¯†ç ä¹Ÿåºåˆ—åŒ–ï¼Œåˆä¸æƒ³ä¿®æ”¹Userç»“æ„ä½“ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨åˆ›å»ºå¦å¤–ä¸€ä¸ªç»“æ„ä½“PublicUseråŒ¿ååµŒå¥—åŸUserï¼ŒåŒæ—¶æŒ‡å®šPasswordå­—æ®µä¸ºåŒ¿åç»“æ„ä½“æŒ‡é’ˆç±»å‹ï¼Œå¹¶æ·»åŠ omitemptytagï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 type User4 struct { Name string `json:\"name\"` Password string `json:\"password\"` } type PublicUser struct { *User4 //åŒ¿ååµŒå¥—ï¼ŒæŒ‡é’ˆï¼Œå¯å¿½ç•¥ç©ºçš„Passwordå­—æ®µ Password *struct{} `json:\"password,omitempty\"` //æŒ‡é’ˆï¼Œå¯å¿½ç•¥ç©ºçš„Passwordå­—æ®µ } //omitPasswordDemo func main3() { u1 := User4{ Name: \"67in\", Password: \"123345\", } publicUser := PublicUser{ User4: \u0026u1, } fmt.Printf(\"publicUser: %v\\n\", publicUser.User4) fmt.Printf(\"publicUser: %v\\n\", publicUser.User4.Password) fmt.Printf(\"publicUser: %v\\n\", publicUser.Password) b, err := json.Marshal(publicUser) if err != nil { fmt.Printf(\"json.Marshal u1 failed, err:%v\\n\", err) return } fmt.Printf(\"str:%s\\n\", b) //è¾“å‡ºstr:{\"name\":\"67in\"} } ä¼˜é›…å¤„ç†å­—ç¬¦ä¸²æ ¼å¼çš„æ•°å­— jsonæ•°æ®ä¸­stringç±»å‹æ•°å­—ååºåˆ—åŒ–ä¸ºæ•°å­—ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type Card struct { ID int64 `json:\"id,string\"` Score float64 `json:\"score,string\"` } //initAndStringDemo func main4() { jsonStr1 := `{\"id\":\"1234567\",\"score\":\"88.50\"}` var c1 Card if err := json.Unmarshal([]byte(jsonStr1), \u0026c1); err != nil { fmt.Printf(\"json.Unmarshal jsonStr1 failed, err:%v\\n\", err) return } fmt.Printf(\"c1:%#v\\n\", c1) } æ•´æ•°å˜æµ®ç‚¹æ•° åœ¨JSONåè®®ä¸­æ˜¯æ²¡æœ‰æ•´å‹å’Œæµ®ç‚¹å‹ä¹‹åˆ†çš„ï¼Œç»Ÿç§°ä¸ºnumberã€‚ Jsonå­—ç¬¦ä¸²ä¸­çš„æ•°å­—ç»è¿‡Goè¯­è¨€ä¸­çš„jsonåŒ…ååºåˆ—åŒ–ä¹‹åéƒ½ä¼šæˆä¸ºfloat64ç±»å‹ é€šå¸¸è¿™å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹å°±ä¼šäº§ç”Ÿæ„æƒ³ä¸åˆ°çš„ç»“æœã€‚æ¯”å¦‚ï¼Œå°†Jsonæ ¼å¼çš„æ•°æ® ååºåˆ—åŒ–ä¸ºmap[string]interface{}æ—¶ï¼Œæ•°å­—éƒ½å˜æˆç§‘å­¦è®¡æ•°æ³•è¡¨ç¤ºçš„æµ®ç‚¹æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 func main5() { type student struct { ID int64 `json:\"id\"` Name string `json:\"name\"` } s := student{ ID: 123456789, Name: \"q1mi\", } b, _ := json.Marshal(s) var m map[string]interface{} //decode json.Unmarshal(b, \u0026m) fmt.Printf(\"id:%#v\\n\", m[\"id\"]) fmt.Printf(\"id type: %T\\n\", m[\"id\"]) //use Number decode decoder := json.NewDecoder(bytes.NewReader(b)) decoder.UseNumber() decoder.Decode(\u0026m) fmt.Printf(\"id:%#v\\n\", m[\"id\"]) fmt.Printf(\"id type:%T\\n\", m[\"id\"]) } //id:1.23456789e+08 //id type: float64 //id:\"123456789\" //id type:json.Number func main6() { //map[string]interface{} -\u003e json string var m = make(map[string]interface{}, 1) m[\"count\"] = 1 //int b, err := json.Marshal(m) if err != nil { fmt.Printf(\"marshal failed, err:%v\\n\", err) } fmt.Printf(\"str:%#v\\n\", string(b)) //json string -\u003e map[string]interface{} var m2 map[string]interface{} err = json.Unmarshal(b, \u0026m2) if err != nil { fmt.Printf(\"unmarshal failed, err:%v\\n\", err) return } fmt.Printf(\"value:%v\\n\", m2[\"count\"]) fmt.Printf(\"value type:%T\\n\", m2[\"count\"]) } //str:\"{\\\"count\\\":1}\" //value:1 //value type:float64 å¦‚æœæƒ³æ›´åˆç†çš„å¤„ç†æ•°å­—å°±éœ€è¦ä½¿ç”¨decoderå»ååºåˆ—åŒ–ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 func main7() { //map[string]interface{} -\u003e json string var m = make(map[string]interface{}, 1) m[\"count\"] = 1 //int b, err := json.Marshal(m) if err != nil { fmt.Printf(\"marshal failed, err:%v\\n\", err) } fmt.Printf(\"str:%#v\\n\", string(b)) //json string -\u003e map[string]interface{} var m2 map[string]interface{} //ä½¿ç”¨decoderæ–¹å¼ååºåˆ—åŒ–ï¼ŒæŒ‡å®šä½¿ç”¨numberç±»å‹ decoder := json.NewDecoder(bytes.NewReader(b)) decoder.UseNumber() err = decoder.Decode(\u0026m2) if err != nil { fmt.Printf(\"unmarshal failed, err:%v\\n\", err) return } fmt.Printf(\"value:%v\\n\", m2[\"count\"]) // 1 fmt.Printf(\"type:%T\\n\", m2[\"count\"]) // json.Number count, err := m2[\"count\"].(json.Number).Int64() //å°†m2[\"count\"]è½¬ä¸ºjson.Numberåè°ƒç”¨Int64æ–¹æ³•è·å¾—int64ç±»å‹çš„å€¼ if err != nil { fmt.Printf(\"parse to int64 failed, err: %v\\n\", err) return } fmt.Printf(\"type:%T\\n\", int(count)) } //str:\"{\\\"count\\\":1}\" //value:1 //type:json.Number //type:int è‡ªå®šä¹‰è§£ææ—¶é—´å­—æ®µ å†…ç½®çš„jsonåŒ…ä¸è¯†åˆ«æˆ‘ä»¬å¸¸ç”¨çš„å­—ç¬¦ä¸²æ—¶é—´æ ¼å¼ï¼Œå¦‚2022-11-03 10:00:00ã€‚ä¸è¿‡æˆ‘ä»¬é€šè¿‡å®ç° json.Marshaler/json.Unmarshaler æ¥å£å®ç°è‡ªå®šä¹‰çš„äº‹ä»¶æ ¼å¼è§£æã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 type CustomTime time.Time //é¦–å­—æ¯è¦å¤§å†™ const CtLayout = \"2006-01-02 15:04:05\" func (t *CustomTime) UnmarshalJSON(data []byte) (err error) { if string(data) == `\"\"` { return } now, err := time.ParseInLocation(`\"`+CtLayout+`\"`, string(data), time.Local) *t = CustomTime(now) return } func (ct CustomTime) MarshalJSON() ([]byte, error) { b := make([]byte, 0, len(CtLayout)+2) b = append(b, '\"') if !time.Time(ct).IsZero() || !time.Time(ct).Truncate(8*time.Hour).IsZero() { b = time.Time(ct).AppendFormat(b, CtLayout) } b = append(b, '\"') return b, nil } type Post1 struct { CreateTime CustomTime `json:\"create_time\"` } func main9() { p1 := Post1{ CreateTime: CustomTime(time.Now()), } b, err := json.Marshal(p1) if err != nil { fmt.Printf(\"json.Marshal p1 failed, err:%v\\n\", err) return } fmt.Printf(\"str:%s\\n\", b) jsonStr := `{\"create_time\":\"2022-11-03 11:14:06\"}` var p3 Post1 if err := json.Unmarshal([]byte(jsonStr), \u0026p3); err != nil { fmt.Printf(\"json.Unmarshal failed, err:%v\\n\", err) return } fmt.Println(p3.CreateTime) fmt.Printf(\"p3:%v\\n\", p3.CreateTime) fmt.Printf(\"p3:%#v\\n\", p3.CreateTime) } ä½¿ç”¨åŒ¿åç»“æ„ä½“æ·»åŠ å­—æ®µ ä½¿ç”¨å†…åµŒç»“æ„ä½“èƒ½å¤Ÿæ‰©å±•ç»“æ„ä½“çš„å­—æ®µï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬æ²¡æœ‰å¿…è¦å•ç‹¬å®šä¹‰æ–°çš„ç»“æ„ä½“ï¼Œå¯ä»¥ä½¿ç”¨åŒ¿åç»“æ„ä½“ç®€åŒ–æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 type UserInfo struct { ID int `json:\"id\"` Name string `json:\"name\"` } func main11() { u1 := UserInfo{ ID: 123456, Name: \"ä¸ƒç±³\", } // ä½¿ç”¨åŒ¿åç»“æ„ä½“å†…åµŒUserå¹¶æ·»åŠ é¢å¤–å­—æ®µToken b, err := json.Marshal(struct { *UserInfo Token string `json:\"token\"` }{ \u0026u1, \"91je3a4s72d1da96h\", }) if err != nil { fmt.Printf(\"json.Marsha failed, err:%v\\n\", err) return } fmt.Printf(\"str:%s\\n\", b) // str:{\"id\":123456,\"name\":\"ä¸ƒç±³\",\"token\":\"91je3a4s72d1da96h\"} } ä½¿ç”¨åŒ¿åç»“æ„ä½“ç»„åˆå¤šä¸ªç»“æ„ä½“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 type Comment struct { Content string } type Image struct { Title string `json:\"title\"` URL string `json:\"url\"` } func main12() { c1 := Comment{ Content: \"æ°¸è¿œä¸è¦é«˜ä¼°è‡ªå·±\", } i1 := Image{ Title: \"èµèµç \", URL: \"https://www.liwenzhou.com/images/zanshang_qr.jpg\", } // struct -\u003e json string b, err := json.Marshal(struct { *Comment *Image }{\u0026c1, \u0026i1}) if err != nil { fmt.Printf(\"json.Marshal failed, err:%v\\n\", err) return } fmt.Printf(\"str:%s\\n\", b) // json string -\u003e struct jsonStr := `{\"Content\":\"æ°¸è¿œä¸è¦é«˜ä¼°è‡ªå·±\",\"title\":\"èµèµç \",\"url\":\"https://www.liwenzhou.com/images/zanshang_qr.jpg\"}` var ( c2 Comment i2 Image ) if err := json.Unmarshal([]byte(jsonStr), \u0026struct { *Comment *Image }{\u0026c2, \u0026i2}); err != nil { fmt.Printf(\"json.Unmarshal failed, err:%v\\n\", err) return } fmt.Printf(\"c2:%#v i2:%#v\\n\", c2, i2) } //str:{\"Content\":\"æ°¸è¿œä¸è¦é«˜ä¼°è‡ªå·±\",\"title\":\"èµèµç \",\"url\":\"https://www.liwenzhou.com/images/zanshang_qr.jpg\"} //c2:main.Comment{Content:\"æ°¸è¿œä¸è¦é«˜ä¼°è‡ªå·±\"} i2:main.Image{Title:\"èµèµç \", URL:\"https://www.liwenzhou.com/images/zanshang_qr.jpg\"} json.RawMessage å¤„ç†ä¸ç¡®å®šå±‚çº§çš„json å¦‚æœjsonä¸²æ²¡æœ‰å›ºå®šçš„æ ¼å¼å¯¼è‡´ä¸å¥½å®šä¹‰ä¸å…¶ç›¸å¯¹åº”çš„ç»“æ„ä½“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨json.RawMessageåŸå§‹å­—èŠ‚æ•°æ®ä¿å­˜ä¸‹æ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type sendMsg struct { User string `json:\"user\"` Msg string `json:\"msg\"` } func main13() { jsonStr := `{\"sendMsg\":{\"user\":\"q1mi\",\"msg\":\"æ°¸è¿œä¸è¦é«˜ä¼°è‡ªå·±\"},\"say\":\"Hello\"}` //å®šä¹‰ä¸€ä¸ªmapï¼Œvalueç±»å‹ä¸ºjson.RawMessage var data map[string]json.RawMessage if err := json.Unmarshal([]byte(jsonStr), \u0026data); err != nil { fmt.Println(err) return } var msg sendMsg if err := json.Unmarshal(data[\"sendMsg\"], \u0026msg); err != nil { fmt.Println(err) return } fmt.Println(msg) } ","description":"","tags":["GOLANG"],"title":"Goè¯­è¨€jsonæŠ€å·§","uri":"/posts/go_json/"},{"categories":null,"content":"Kafka StandaloneConsumer ç‹¬ç«‹æ¶ˆè´¹è€… Standalone Consumer æ¯æ¬¡éƒ½ä¼šä»ç¬¬1æ¡æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œä¸€ç›´åˆ°æ¶ˆè´¹å®Œ å…¨éƒ¨æ¶ˆæ¯ï¼Œä¸ä¼šè®°å½•offsetï¼Œå¦¥å¦¥çš„é‡å¤æ¶ˆè´¹ï¼Œéœ€è¦å€ŸåŠ© OffsetManager æ¥å®Œæˆã€‚\næœªä½¿ç”¨OffsetManagerçš„StandaloneConsumer å•åˆ†åŒºæ¶ˆè´¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func SinglePartition(topic string) { config := sarama.NewConfig() host := \"x.x.x.x:xx\" consumer, err := sarama.NewConsumer([]string{host}, config) if err != nil { log.Fatal(\"NewConsumer err:\", err) } defer consumer.Close() //ç‹¬ç«‹æ¶ˆè´¹è€…ä¸­ sarama.OffsetOldest ä¼šä»æœ€æ—§çš„æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œå³æ¯æ¬¡é‡å¯ consumerå éƒ½ä¼šæŠŠè¯¥topicä¸‹çš„æ‰€æœ‰æ¶ˆæ¯éƒ½æ¶ˆè´¹ä¸€æ¬¡ partitionConsumer, err := consumer.ConsumePartition(topic, 0, sarama.OffsetOldest) if err != nil { log.Fatal(\"ConsumePartition err:\", err) } defer partitionConsumer.Close() //ä¼šä¸€ç›´é˜»å¡åœ¨è¿™é‡Œ for message := range partitionConsumer.Messages() { log.Printf(\"[Consumer] partitionid:%d; offset:%d, value:%s\\n\", message.Partition, message.Offset, string(message.Value)) } } å¤šåˆ†åŒºæ¶ˆè´¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 func Partitions(topic string) { config := sarama.NewConfig() host := \"x.x.x.x:xx\" consumer, err := sarama.NewConsumer([]string{host}, config) if err != nil { log.Fatal(\"NewConsumer err: err\") } defer consumer.Close() //å…ˆæŸ¥è¯¢ topicæœ‰å¤šå°‘åˆ†åŒº partitions, err := consumer.Partitions(topic) if err != nil { log.Fatal(\"Partitions err:\", err) } var wg sync.WaitGroup wg.Add(len(partitions)) //ç„¶åæ¯ä¸ªåˆ†åŒºå¼€ä¸€ä¸ªgoroutineæ¥æ¶ˆè´¹ for _, partitionId := range partitions { go consumeByPartition(consumer, topic, partitionId, \u0026wg) } wg.Wait() } func consumeByPartition(consumer sarama.Consumer, topic string, partitionId int32, wg *sync.WaitGroup) { defer wg.Done() partitionConsumer, err := consumer.ConsumePartition(topic, partitionId, sarama.OffsetOldest) if err != nil { log.Fatal(\"ConsumePartition err:\", err) } defer partitionConsumer.Close() for message := range partitionConsumer.Messages() { log.Printf(\"[Consumer] partitionid:%d; offset:%d, value:%s\\n\", message.Partition, message.Offset, string(message.Value)) } } åå¤è¿è¡Œä¸Šé¢çš„Demoä¼šå‘ç°ï¼Œæ¯æ¬¡éƒ½ä¼šä»ç¬¬1æ¡æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œä¸€ç›´åˆ°æ¶ˆè´¹å®Œ å…¨éƒ¨æ¶ˆæ¯ã€‚ è¿™ä¸æ˜¯å¦¥å¦¥çš„é‡å¤æ¶ˆè´¹å—ï¼Ÿ Kafkaå’Œå…¶ä»–MQæœ€å¤§çš„åŒºåˆ«åœ¨äºKafkaä¸­çš„æ¶ˆæ¯å†æ¶ˆè´¹åä¸ä¼šè¢«åˆ é™¤ï¼Œè€Œæ˜¯ä¼šä¸€ç›´ä¿ç•™ï¼Œç›´åˆ°è¿‡æœŸã€‚ ä¸ºäº†é˜²æ­¢æ¯æ¬¡é‡å¯æ¶ˆè´¹è€…éƒ½ä»ç¬¬1æ¡æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œæˆ‘ä»¬éœ€è¦å†æ¶ˆè´¹æ¶ˆæ¯åå°†offsetæäº¤ç»™Kafkaã€‚è¿™æ ·é‡å¯åå°±å¯ä»¥æ¥ç€ä¸Šæ¬¡çš„Offsetç»§ç»­æ¶ˆè´¹äº†\nåœ¨ç‹¬ç«‹æ¶ˆè´¹è€…ä¸­æ²¡æœ‰å®ç°æäº¤Offsetçš„åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ©OffsetManageræ¥å®Œæˆ\nä½¿ç”¨OffsetManagerçš„StandaloneConsumer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 func OffsetManager(topic string) { config := sarama.NewConfig() host := \"x.x.x.x:xx\" //é…ç½®å¼€å¯è‡ªåŠ¨æäº¤offsetï¼Œ è¿™æ ·samaraåº“ä¼šè‡ªåŠ¨æŠŠæœ€æ–°çš„offsetæäº¤ç»™kafka config.Consumer.Offsets.AutoCommit.Enable = true //å¼€å¯è‡ªåŠ¨commit offset config.Consumer.Offsets.AutoCommit.Interval = 1 * time.Second //è‡ªåŠ¨ commitæ—¶é—´é—´éš” client, err := sarama.NewClient([]string{host}, config) if err != nil { log.Fatal(\"NewClient err:\", err) } defer client.Close() consumer, err := sarama.NewConsumerFromClient(client) if err != nil { log.Println(\"NewConsumeFromClient err:\", err) } defer consumer.Close() // å…ˆæŸ¥è¯¢è¯¥ topic æœ‰å¤šå°‘åˆ†åŒº partitions, err := consumer.Partitions(topic) if err != nil { log.Fatal(\"Partitions err: \", err) } var wg sync.WaitGroup wg.Add(len(partitions)) for _, partitionId := range partitions { go ConsumeByOffsetManager(client, partitionId, \u0026wg, consumer) } wg.Wait() } func ConsumeByOffsetManager(client sarama.Client, i int32, wg *sync.WaitGroup, consumer sarama.Consumer) { defer wg.Done() //offsetManagerç”¨äºç®¡ç†æ¯ä¸ªConsumerGroupçš„offset //æ ¹æ®groupIdæ¥åŒºåˆ†ä¸åŒçš„consume, æ³¨æ„ï¼šæ¯æ¬¡æäº¤çš„offsetä¿¡æ¯ä¹Ÿæ˜¯å’ŒgroupIdå…³è”çš„ offsetManager, err := sarama.NewOffsetManagerFromClient(\"myGroupId\", client) //åç§»ç®¡ç†å™¨ if err != nil { log.Println(\"NewOffsetManagerFromClient err:\", err) } defer offsetManager.Close() partitionOffsetManager, err := offsetManager.ManagePartition(\"topic_name\", i) //å¯¹åº”åˆ†åŒºçš„åç§»é‡ç®¡ç†ç®¡ç†å™¨ if err != nil { log.Println(\"ManagerPartition err:\", err) } defer partitionOffsetManager.Close() //deferåœ¨ç¨‹åºç»“æŸåå†commitä¸€æ¬¡ï¼Œé˜²æ­¢è‡ªåŠ¨æäº¤é—´éš”ä¹‹é—´çš„ä¿¡æ¯è¢«ä¸¢æ‰ defer offsetManager.Commit() //æ ¹æ®kafkaä¸­è®°å½•çš„ä¸Šæ¬¡æ¶ˆè´¹çš„offsetå¼€å§‹+1çš„ä½ç½®æ¥ç€æ¶ˆè´¹ nextOffset, _ := partitionOffsetManager.NextOffset() fmt.Println(\"nextOffset:\", nextOffset) pc, err := consumer.ConsumePartition(\"topic_name\", i, nextOffset) if err != nil { log.Println(\"ConsumePartition err:\", err) } defer pc.Close() for message := range pc.Messages() { value := string(message.Value) log.Printf(\"[Consumer] partitionid:%d; offset:%d, value:%s\\n\", message.Partition, message.Offset, value) //æ¯æ¬¡æ¶ˆè´¹åéƒ½æ›´æ–°ä¸€æ¬¡offsetï¼Œè¿™é‡Œæ›´æ–°çš„åªæ˜¯ç¨‹åºå†…å­˜ä¸­çš„å€¼ï¼Œéœ€è¦commitåæ‰èƒ½æäº¤åˆ°Kafka partitionOffsetManager.MarkOffset(message.Offset+1, \"modified metadata\") } } 1ï¼‰åˆ›å»ºåç§»é‡ç®¡ç†å™¨\noffsetManager, _ := sarama.NewOffsetManagerFromClient(\"myGroupID\", client) 2ï¼‰åˆ›å»ºå¯¹åº”åˆ†åŒºçš„åç§»é‡ç®¡ç†å™¨\nKafka ä¸­æ¯ä¸ªåˆ†åŒºçš„åç§»é‡æ˜¯å•ç‹¬ç®¡ç†çš„\npartitionOffsetManager, _ := offsetManager.ManagePartition(topic, kafka.DefaultPartition) 3ï¼‰è®°å½•åç§»é‡\nè¿™é‡Œè®°å½•çš„æ˜¯ä¸‹ä¸€æ¡è¦å–çš„æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯å–çš„æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦ +1\npartitionOffsetManager.MarkOffset(message.Offset+1, \"modified metadata\") 4ï¼‰æäº¤åç§»é‡\nsarama ä¸­é»˜è®¤ä¼šè‡ªåŠ¨æäº¤åç§»é‡ï¼Œä½†è¿˜æ˜¯å»ºè®®ç”¨ defer åœ¨ç¨‹åºé€€å‡ºçš„æ—¶å€™æ‰‹åŠ¨æäº¤ä¸€æ¬¡ã€‚\ndefer offsetManager.Commit() æ›´å¤šè¯·çœ‹ ï¼šhttps://www.lixueduan.com/posts/kafka/05-quick-start/#3-consumer-api\n","description":"","tags":["Kafka"],"title":"Kafka ä¸é‡å¤æ¶ˆè´¹","uri":"/posts/kafka/"},{"categories":null,"content":"ä»€ä¹ˆæ˜¯defer Goè¯­è¨€çš„ä¸€ç§ç”¨äºæ³¨å†Œå»¶è¿Ÿè°ƒç”¨çš„æœºåˆ¶ï¼Œä½¿å¾—å‡½æ•°æˆ–è¯­å¥å¯ä»¥åœ¨å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œã€‚\nä¸ºä»€ä¹ˆéœ€è¦defer Goæä¾›çš„è¯­æ³•ç³–ï¼Œå‡å°‘èµ„æºæ³„éœ²çš„å‘ç”Ÿã€‚\nå¦‚ä½•ä½¿ç”¨defer åœ¨åˆ›å»ºèµ„æºè¯­å¥çš„é™„è¿‘ï¼Œä½¿ç”¨deferè¯­å¥é‡Šæ”¾èµ„æºã€‚\ndeferè¯­å¥çš„æ‰§è¡Œé¡ºåº deferè¯­å¥ä¸ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯ä¼šè¿›å…¥ä¸€ä¸ªæ ˆã€‚å‡½æ•°returnå‰ï¼Œæœ€å…ˆå®šä¹‰çš„deferè¯­å¥æœ€åæ‰§è¡Œã€‚\ndeferå‡½æ•°å®šä¹‰æ—¶ï¼Œå¯¹å¤–éƒ¨å˜é‡æœ‰ä¸¤ç§æ–¹å¼ï¼š\nå‡½æ•°å‚æ•°: åœ¨deferå®šä¹‰æ—¶å°±æŠŠå€¼ä¼ é€’ç»™deferï¼Œå¹¶è¢«cacheèµ·æ¥ï¼› é—­åŒ…å¼•ç”¨: åœ¨deferå‡½æ•°çœŸæ­£è°ƒç”¨æ—¶æ ¹æ®æ•´ä¸ªä¸Šä¸‹æ–‡ç¡®å®šå‚æ•°å½“å‰çš„å€¼ å‡½æ•°å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 func main() { var whatever [3]struct{} for i := range whatever { defer func(i int) { fmt.Println(i) }(i) } } $ go run main.go 2 1 0 é—­åŒ…å¼•ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func main(){ var whatever [3]struct{} for i := range whatever{ defer func(){ fmt.Println(i) }() } } $ go run main.go 2 2 2 deferçš„æ‰§è¡Œé¡ºåºå’Œå®šä¹‰çš„é¡ºåºç›¸åã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package main import ( \"fmt\" ) type number int func (n number) print() { fmt.Println(n) } func (n *number) pprint() { fmt.Println(*n) } func main() { var n number defer n.print() defer n.pprint() defer func() { n.print() }() defer func() { n.pprint() }() n = 3 } $ go run main.go 3 //ç¬¬å››ä¸ªdeferè¯­å¥æ˜¯é—­åŒ…ï¼Œå¼•ç”¨å¤–éƒ¨å‡½æ•°çš„nï¼Œæœ€ç»ˆç»“æœæ˜¯3 3 //ç¬¬ä¸‰ä¸ªdeferåŒä¸Š 3 //ç¬¬äºŒä¸ªdeferè¯­å¥ä¸­çš„næ˜¯å¼•ç”¨ï¼Œæœ€ç»ˆæ˜¯3 0 //ç¬¬ä¸€ä¸ª æ˜¯å¯¹nç›´æ¥æ±‚å€¼ï¼Œå¼€å§‹çš„æ—¶å€™n=0,æ‰€ä»¥æœ€åæ˜¯0 å¦‚æœdeferåƒå‰é¢ä»‹ç»çš„é‚£æ ·ç®€å•ï¼Œè¿™ä¸ªä¸–ç•Œå°±å®Œç¾äº†ã€‚ä½†äº‹æƒ…æ€»æ˜¯æ²¡è¿™ä¹ˆç®€å•ï¼Œdeferç”¨å¾—ä¸å¥½ï¼Œä¼šé™·å…¥æ³¥æ½­ã€‚å…¶ä»–ä¾‹å­ï¼š\ndefer å…³é”®å­—ä½¿ç”¨ä¼ å€¼çš„æ–¹å¼ä¼ é€’å‚æ•°æ—¶ä¼šè¿›è¡Œé¢„è®¡ç®—ï¼Œå¯¼è‡´ä¸ç¬¦åˆé¢„æœŸçš„ç»“æœï¼›\n1 2 3 4 5 6 7 8 9 func main() { startedAt := time.Now() defer fmt.Println(time.Since(startedAt)) time.Sleep(time.Second) } $go run main.go 168.518Âµs è°ƒç”¨ defer å…³é”®å­—ä¼šç«‹åˆ»æ‹·è´å‡½æ•°ä¸­å¼•ç”¨çš„å¤–éƒ¨å‚æ•°ï¼Œæ‰€ä»¥ time.Since(startedAt) çš„ç»“æœä¸æ˜¯åœ¨ main å‡½æ•°é€€å‡ºä¹‹å‰è®¡ç®—çš„ï¼Œè€Œæ˜¯åœ¨ defer å…³é”®å­—è°ƒç”¨æ—¶è®¡ç®—çš„ï¼Œæœ€ç»ˆå¯¼è‡´ä¸Šè¿°ä»£ç è¾“å‡º 0sã€‚\n1 2 3 4 5 6 7 8 9 10 11 func main() { startedAt := time.Now() defer func() { fmt.Println(time.Since(startedAt)) }() time.Sleep(time.Second) } $ go run main.go 1.001001205s æ‹†è§£å»¶è¿Ÿè¯­å¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main import ( \"fmt\" ) func f1() (r int) { t := 5 fmt.Println(\u0026t) fmt.Println(\u0026r) defer func() { t = t + 5 }() return t } func main() { fmt.Println(f1()) } $ go run main.go 5 å¿…é¡»æ·±åˆ»ç†è§£return t,è¿™å¥ç¼–è¯‘ä¹‹åï¼Œå®é™…ä¸Šç”Ÿæˆä¸‰æ¡æŒ‡ä»¤ï¼š\n1 2 3 1. è¿”å›å€¼ r = t 2. è°ƒç”¨ deferå‡½æ•°ï¼Œæ“ä½œçš„æ˜¯t 3. ç©ºçš„return 1ã€3æ˜¯returnç”Ÿæˆçš„æŒ‡ä»¤ï¼Œreturnå¹¶ä¸æ˜¯ä¸€æ¡åŸå­æŒ‡ä»¤\n2 å®é™…ä¸Šå¹¶æ²¡æœ‰æ“ä½œè¿”å›å€¼rï¼Œæ“ä½œçš„æ˜¯tï¼Œå¯ä»¥æ‰“å°å‡ºt, rçš„åœ°å€æ˜¯ä¸ä¸€æ ·çš„ã€‚\nå†çœ‹ä¸€ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package main import ( \"fmt\" ) func f() (r int) { fmt.Println(\u0026r) defer func(r int) { fmt.Println(\u0026r) r = r + 5 }(r) return 1 } func main() { fmt.Println(f()) } $ go run main.go 0xc0000160a8 0xc0000160c0 1 æ‹†è§£ï¼š\n1 2 3 1. è¿”å›å€¼ r =1 2. é—­åŒ…ï¼Œä¼ å‚ï¼Œæ‰“å°ä¸¤ä¸ªrçš„åœ°å€ï¼Œä¸æ˜¯ä¸€ä¸ªrã€‚ä¼ å€¼è¿›å»çš„rï¼Œæ˜¯å½¢å‚çš„ä¸€ä¸ªå¤åˆ¶å€¼ï¼Œä¸ä¼šå½±å“å®å‚rã€‚ 3. ç©ºçš„return ç¡®å®šå»¶è¿Ÿè¯­å¥çš„å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package main import ( \"errors\" \"fmt\" ) func e1() { var err error defer fmt.Println(err) err = errors.New(\"defer1 error\") return } func e2() { var err error defer func() { fmt.Println(err) }() err = errors.New(\"defer2 error\") return } func e3() { var err error defer func() { fmt.Println(err) }() err = errors.New(\"defer3 error\") return } func main() { e1() e2() e3() } //æ‰§è¡Œe1,e3æ—¶å€™ï¼Œå£°æ˜åï¼Œä¼ å…¥deferçš„æ˜¯nil,ç„¶åè¢«deferå¡å…¥æ ˆä¸­ //e2é—­åŒ…ä½¿ç”¨çš„æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥ä¼šæ‰“å°defer2 error $ go run main.go \u003cnil\u003e defer2 error \u003cnil\u003e å»¶è¿Ÿè¯­å¥é…åˆæ¢å¤è¯­å¥ recover()å‡½æ•°åªåœ¨deferçš„å‡½æ•°ä¸­ç›´æ¥è°ƒç”¨æ‰æœ‰æ•ˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package main import ( \"fmt\" \"time\" ) func main() { defer fmt.Println(\"defer main\") var user = \"\" go func() { defer func() { fmt.Println(\"defer caller\") if err := recover(); err != nil { fmt.Println(\"recover success err:\", err) } }() defer func() { defer func() { fmt.Println(\"defer here\") }() if user == \"\" { panic(\"should set user env\") } fmt.Println(\"after panic\") }() }() time.Sleep(1000) fmt.Println(\"end of main function\") } $ go run main.go end of main function defer main defer here defer caller recover success err: should set user env panicä¼šåœæ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼Œè€Œä¸åªæ˜¯å½“å‰çº¿ç¨‹ã€‚åœ¨è¿™ä¹‹å‰ï¼Œå®ƒä¼šæœ‰åºåœ°æ‰§è¡Œå®Œå½“å‰çº¿ç¨‹deferåˆ—è¡¨é‡Œçš„è¯­å¥ï¼Œå…¶ä»–åç¨‹é‡Œå®šä¹‰çš„deferè¯­å¥ä¸åšä¿è¯ã€‚æ‰€ä»¥åœ¨deferé‡Œå®šä¹‰ä¸€ä¸ªrecoverè¯­å¥ï¼Œé˜²æ­¢ç¨‹åºç›´æ¥æŒ‚æ‰ï¼Œå°±å¯ä»¥èµ·åˆ°tryâ€¦catchçš„æ•ˆæœã€‚\nå…¶ä»– Goè°ƒåº¦æ¨¡å‹ ä¸‰ä¸ªå®ä½“ï¼šM(Machine)ã€P(Processor)ã€G(Goroutine)\nG: Goè¿è¡Œæ—¶å¯¹goroutineçš„æè¿°ï¼ŒGä¸­å­˜æ”¾å¹¶å‘æ‰§è¡Œçš„ä»£ç å…¥å£åœ°å€ã€ä¸Šä¸‹æ–‡ã€è¿è¡Œç¯å¢ƒ(å…³è”çš„På’ŒM)ã€è¿è¡Œæ ˆç­‰æ‰§è¡Œç›¸å…³çš„ä¿¡æ¯ã€‚\nM: OSå†…æ ¸çº¿ç¨‹ï¼Œæ˜¯æ“ä½œç³»ç»Ÿå±‚é¢è°ƒåº¦å’Œæ‰§è¡Œçš„å®ä½“ã€‚ç›´æ¥å…³è”ä¸€ä¸ªå†…æ ¸çº§çº¿ç¨‹ã€‚\nP: ä»£è¡¨Må’ŒGæ‰€éœ€è¦çš„èµ„æºï¼Œæ˜¯å¯¹èµ„æºçš„ä¸€ç§æŠ½è±¡ç®¡ç†ï¼ŒPä¸æ˜¯ä¸€æ®µä»£ç å®ä½“ï¼Œè€Œæ˜¯ä¸€ä¸ªç®¡ç†çš„æ•°æ®ç»“æ„ï¼ŒPä¸»è¦æ˜¯é™ä½Må¯¹Gçš„å¤æ‚æ€§ï¼Œå¢åŠ ä¸€ä¸ªé—´æ¥çš„æ§åˆ¶å±‚æ•°æ®ç»“æ„ã€‚Pæ§åˆ¶GOä»£ç çš„å¹¶è¡Œåº¦ï¼Œå®ƒä¸æ˜¯å®ä½“ã€‚\né—­åŒ… é—­åŒ… = å‡½æ•° + å¼•ç”¨ç¯å¢ƒï¼Œ ä¹Ÿç§°åŒ¿åå‡½æ•°ï¼Œä¸èƒ½ç‹¬ç«‹å­˜åœ¨ï¼Œä½†å¯ä»¥ç›´æ¥è°ƒç”¨æˆ–èµ‹å€¼äºæŸä¸ªå˜é‡ã€‚\nä¸å¤ªæ°å½“çš„ä¾‹å­ï¼š å¯ä»¥æŠŠé—­åŒ…çœ‹æˆæ˜¯ä¸€ä¸ªç±»ï¼Œé—­åŒ…å‡½æ•°çš„ä¸€ä¸ªè°ƒç”¨å°±æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªç±»ã€‚é—­åŒ…åœ¨è¿è¡Œæ—¶å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼Œå®ƒä¼šå°†åŒä¸€ä¸ªä½œç”¨åŸŸçš„å˜é‡å’Œå¸¸é‡æ•è·ï¼Œæ— è®ºé—­åŒ…åœ¨ä»€ä¹ˆåœ°æ–¹è°ƒç”¨ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™äº›å˜é‡å’Œå¸¸é‡ã€‚é—­åŒ…æ•è·çš„å˜é‡å’Œå¸¸é‡éƒ½æ˜¯å¼•ç”¨ä¼ é€’ï¼Œä¸æ˜¯å€¼ä¼ é€’ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package main import ( \"fmt\" ) func main() { var a = Accumulator() fmt.Printf(\"%d\\n\", a(1)) fmt.Printf(\"%d\\n\", a(10)) fmt.Printf(\"%d\\n\", a(100)) fmt.Println(\"--------------------------------\") var b = Accumulator() fmt.Printf(\"%d\\n\", b(1)) fmt.Printf(\"%d\\n\", b(10)) fmt.Printf(\"%d\\n\", b(100)) } func Accumulator() func(int) int { var x int return func(delta int) int { fmt.Printf(\"(%+v, %+v) - \", \u0026x, x) x += delta return x } } é—­åŒ…å·²ç”¨äº†xå˜é‡ï¼Œa,bå¯çœ‹ä½œ2ä¸ªä¸åŒçš„å®ä¾‹ï¼Œå®ä¾‹ä¹‹é—´äº’ä¸å½±å“ï¼Œå®ä¾‹å†…éƒ¨ï¼Œxå˜é‡æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œå› æ­¤å…·æœ‰\"ç´¯åŠ æ•ˆåº”\"\n","description":"","tags":["Golang"],"title":"GO Defer","uri":"/posts/go-defer/"},{"categories":null,"content":"é€ƒé€¸åˆ†æ â€œQuality is never an accident; it is always the result of intelligent effort.â€ â€” John Ruskin.\né€ƒé€¸åˆ†ææ˜¯ä»€ä¹ˆ Goç¼–è¯‘å™¨çš„ä¸€ä¸ªé˜¶æ®µï¼Œå¯¹ä»£ç è¿›è¡Œé€ƒé€¸åˆ†æï¼Œç¡®å®šå…¶ä¸­å˜é‡çš„å†…å­˜åˆ†é…ä½ç½®(æ ˆã€å †)ï¼ŒæŠŠå˜é‡åˆç†åœ°åˆ†é…åˆ°å®ƒè¯¥å»çš„åœ°æ–¹ã€‚\né€ƒé€¸æ˜¯ä»€ä¹ˆï¼Ÿå½“ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆè¢«å¤šä¸ªæ–¹æ³•æˆ–çº¿ç¨‹å¼•ç”¨æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæŒ‡é’ˆå°±ä¼šå‘ç”Ÿé€ƒé€¸ã€‚å¦‚æœä¸€ä¸ªå‡½æ•°è¿”å›å¯¹ä¸€ä¸ªå˜é‡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±ä¼šå‘ç”Ÿé€ƒé€¸ã€‚\né€ƒé€¸åˆ†æä½œç”¨ æ ˆï¼šåˆ†é…é€Ÿåº¦å¿«ï¼Œåªéœ€é€šè¿‡PUSHæŒ‡ä»¤ï¼Œå‡½æ•°returnåå¯è‡ªåŠ¨é‡Šæ”¾ å †ï¼šéœ€è¦æ‰¾åˆ°åˆé€‚å¤§å°çš„å†…å­˜å—ï¼Œæ˜“å½¢æˆå†…å­˜ç¢ç‰‡ï¼Œé€šè¿‡åƒåœ¾å›æ”¶æ‰èƒ½é‡Šæ”¾ é€šè¿‡é€ƒé€¸åˆ†æï¼Œå¯ä»¥æŠŠä¸€äº›ä¸éœ€è¦åˆ†é…åˆ°å †ä¸Šçš„å˜é‡ç›´æ¥åˆ†é…åˆ°æ ˆä¸Šï¼Œå‡è½»å †å†…å­˜åˆ†é…çš„å¼€é”€ã€‚GCä¼šå®šæœŸåœæ­¢å¹¶æ”¶é›†æœªä½¿ç”¨çš„å¯¹è±¡ï¼Œè¿™ä¹Ÿå‡è½»äº†GCçš„å‹åŠ›ï¼Œæé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ã€‚\nå¦‚ä½•ç¡®å®šæ˜¯å¦å‘ç”Ÿé€ƒé€¸ ä¾‹å­å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package main import ( \"fmt\" ) func foo() *int { t := 3 return \u0026t } func main() { x := foo() fmt.Println(*x) } ä½¿ç”¨go build -gcflags '-m -l' xx.goæŸ¥çœ‹Goç¼–è¯‘è¿‡ç¨‹ä¸­å˜é‡æ˜¯å¦å‘ç”Ÿé€ƒé€¸ã€‚-gcflagså‚æ•°ç”¨äºå¼ƒç”¨ç¼–è¯‘å™¨æ”¯æŒçš„é¢å¤–æ ‡å¿—ã€‚å¦‚ï¼Œ-mç”¨äºè¾“å‡ºç¼–è¯‘å™¨çš„ä¼˜åŒ–ç»†èŠ‚(åŒ…æ‹¬ä½¿ç”¨é€ƒé€¸åˆ†æè¿™ç§ä¼˜åŒ–)ï¼Œç›¸åå¯ä»¥ä½¿ç”¨-Næ¥å…³é—­ç¼–è¯‘å™¨ä¼˜åŒ–ï¼›è€Œ-låˆ™ç”¨äºç¦ç”¨fooå‡½æ•°çš„å†…è”ä¼˜åŒ–ï¼Œé˜²æ­¢é€ƒé€¸è¢«ç¼–è¯‘å™¨é€šè¿‡å†…è”å½»åº•åœ°æŠ¹é™¤ã€‚\n1 2 3 4 $ go build -gcflags '-m -l' main.go ./escapeAnalysis.go:8:2: moved to heap: t ./escapeAnalysis.go:14:13: ... argument does not escape ./escapeAnalysis.go:14:14: *x escapes to heap å¯ä»¥çœ‹åˆ°tè¢«ç§»åŠ¨åˆ°å †ä¸Šï¼Œå‘ç”Ÿäº†é€ƒé€¸ï¼Œ*xä¹Ÿå‘ç”Ÿäº†é€ƒé€¸ï¼Œå› ä¸ºPrintln()å‡½æ•°çš„å‚æ•°ç±»å‹ä¸ºinterface{}ï¼Œç¼–è¯‘æœŸé—´å¾ˆéš¾ç¡®å®šå…¶å‚æ•°çš„å…·ä½“ç±»å‹ï¼Œä¹Ÿä¼šå‘ç”Ÿé€ƒé€¸ã€‚\nä½¿ç”¨åæ±‡ç¼–å‘½ä»¤ä¹Ÿå¯ä»¥çœ‹å‡ºå˜é‡æ˜¯å¦å‘ç”Ÿé€ƒé€¸ã€‚æ‰§è¡Œå‘½ä»¤ï¼šgo tool compile -S main.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 \"\".foo STEXT size=79 args=0x8 locals=0x18 funcid=0x0 0x0000 00000 (escapeAnalysis.go:7) TEXT \"\".foo(SB), ABIInternal, $24-8 0x0000 00000 (escapeAnalysis.go:7) MOVQ (TLS), CX 0x0009 00009 (escapeAnalysis.go:7) CMPQ SP, 16(CX) 0x000d 00013 (escapeAnalysis.go:7) PCDATA $0, $-2 0x000d 00013 (escapeAnalysis.go:7) JLS 72 0x000f 00015 (escapeAnalysis.go:7) PCDATA $0, $-1 0x000f 00015 (escapeAnalysis.go:7) SUBQ $24, SP 0x0013 00019 (escapeAnalysis.go:7) MOVQ BP, 16(SP) 0x0018 00024 (escapeAnalysis.go:7) LEAQ 16(SP), BP 0x001d 00029 (escapeAnalysis.go:7) FUNCDATA $0, gclocalsÂ·2a5305abe05176240e61b8620e19a815(SB) 0x001d 00029 (escapeAnalysis.go:7) FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 0x001d 00029 (escapeAnalysis.go:8) LEAQ type.int(SB), AX 0x0024 00036 (escapeAnalysis.go:8) MOVQ AX, (SP) 0x0028 00040 (escapeAnalysis.go:8) PCDATA $1, $0 0x0028 00040 (escapeAnalysis.go:8) CALL runtime.newobject(SB) 0x002d 00045 (escapeAnalysis.go:8) MOVQ 8(SP), AX 0x0032 00050 (escapeAnalysis.go:8) MOVQ $3, (AX) 0x0039 00057 (escapeAnalysis.go:9) MOVQ AX, \"\".~r0+32(SP) 0x003e 00062 (escapeAnalysis.go:9) MOVQ 16(SP), BP 0x0043 00067 (escapeAnalysis.go:9) ADDQ $24, SP 0x0047 00071 (escapeAnalysis.go:9) RET 0x0048 00072 (escapeAnalysis.go:9) NOP 0x0048 00072 (escapeAnalysis.go:7) PCDATA $1, $-1 0x0048 00072 (escapeAnalysis.go:7) PCDATA $0, $-2 0x0048 00072 (escapeAnalysis.go:7) CALL runtime.morestack_noctxt(SB) 0x004d 00077 (escapeAnalysis.go:7) PCDATA $0, $-1 0x004d 00077 (escapeAnalysis.go:7) JMP 0 è¿™æ˜¯éƒ¨åˆ†ç»“æœï¼Œå…¶ä¸­æœ‰ä½¿ç”¨runtime.newobject()å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨å †ä¸Šåˆ†é…ä¸€å—å†…å­˜ï¼Œä»è€Œè¯´æ˜å˜é‡å‘ç”Ÿäº†é€ƒé€¸ã€‚\nGoä¸C/C++ä¸­çš„å †æ ˆæ¦‚å¿µçš„åŒºåˆ« C/C++ä¸­çš„å †æ ˆæ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„æ¦‚å¿µï¼Œå®ƒé€šè¿‡ç¼–è¯‘å™¨æ‰€åœ¨çš„ç¯å¢ƒæ¥å†³å®šã€‚\næ ˆï¼šæŒ‡çš„æ˜¯ç¨‹åºè¿è¡Œæ—¶è‡ªåŠ¨è·å¾—çš„ä¸€å°å—å†…å­˜ï¼Œå‡½æ•°è°ƒç”¨æ¶ˆè€—çš„æ ˆçš„å¤§å°ï¼Œä¼šåœ¨ç¼–è¯‘æœŸé—´ç”±ç¼–è¯‘å™¨å†³å®šã€‚è¿™å—å†…å­˜ç”¨äºä¿å­˜å±€éƒ¨å˜é‡æˆ–è€…ä¿å­˜å‡½æ•°è°ƒç”¨æ ˆã€‚ï¼ˆ1MBï¼‰ å †ï¼šæ¯å½“ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜æ—¶ï¼Œä¼šå°†æ‰€éœ€çš„ç©ºé—´ä»ç»´æŠ¤çš„å †å†…å­˜åœ°å€ç©ºé—´ä¸­åˆ†é…å‡ºå»ï¼Œè€Œåœ¨å½’è¿˜æ˜¯å°†å½’è¿˜çš„å†…å­˜åˆå¹¶åˆ°æ‰€ç»´æŠ¤çš„åœ°å€ç©ºé—´ä¸­ã€‚ï¼ˆ1GBï¼‰ Goè¯­è¨€ä¸­çš„å †æ ˆä¸C/C++ä¸­çš„æœ‰è¾ƒå¤§åŒºåˆ«ã€‚Goè¯­è¨€ä¸­çš„å †æ ˆéƒ½æŒ‡çš„æ˜¯Goè¿è¡Œæ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·çš„å †å†…å­˜ï¼Œè¢«å…¨éƒ¨ç”¨äºGoçš„è¿è¡Œæ—¶ï¼Œç»´æŠ¤è¿è¡Œæ—¶å„ä¸ªç»„ä»¶çš„åè°ƒã€‚è°ƒåº¦å™¨ã€åƒåœ¾å›æ”¶ã€ç³»ç»Ÿè°ƒç”¨ç­‰ã€‚æ‰€ä»¥ä»ç†è®ºä¸Šæ¥è¯´ï¼Œç›¸è¾ƒäºåªæœ‰1MBçš„C/C++ä¸­çš„æ ˆè€Œè¨€ï¼ŒGoå¯ä»¥æ‹¥æœ‰1GBçš„æ ˆå†…å­˜ã€‚\nGoæŒ‡é’ˆä¸èƒ½ç®—æœ¯è¿ç®— Goè¯­è¨€è¿è¡Œæ—¶ä¸ºäº†é˜²æ­¢å†…å­˜ç¢ç‰‡åŒ–ï¼Œä¼šé€‚å½“å¯¹æ•´ä¸ªæ ˆè¿›è¡Œæ·±æ‹·è´ï¼Œå°†å…¶æ•´ä¸ªå¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜ï¼ˆè¿™ä¸ªè¿‡ç¨‹å¯¹ç”¨æˆ·æ€çš„ä»£ç æ˜¯ä¸å¯è§çš„ï¼‰ï¼Œæ‰€ä»¥åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ— æ³•ç¡®å®šè¿ç®—å‰åæŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€å†…å®¹æ˜¯å¦è¢«è¿è¡Œæ—¶ç§»åŠ¨ã€‚ä¹Ÿæ­£æ˜¯è¿™ä¸ªåŸå› ï¼ŒæŒ‡é’ˆçš„ç®—æœ¯è¿ç®—ä¸å†èƒ½ç”Ÿæ•ˆã€‚\n","description":"","tags":["Golang"],"title":"GO Escape Analysis","uri":"/posts/go-escape-analysis/"}]