---
title: "HighConcurrentSystem_ch01"
date: 2023-03-08T18:28:56+08:00
draft: false
tags:
  - 高并发系统 
---

# 用户中心-结构梳理：大并发下，你的数据库表可能成为性能隐患

## 结构梳理

> 从数据结构出发，对场景进行改造。先梳理数据库结构，再对系统进行高并发改造

用户中心的主要功能是维护用户信息、用户权限和登录状态，它保存的数据大部分都属于读多写少的数据。用户中心常见的优化方式主要是将用户中心和业务彻底拆开，不再与业务耦合，并适当增加缓存来提高系统性能。

精简数据量虽然能换来更好的响应速度，但不提倡过度设计。因为表字段如果缺少冗余会导致业务实现更为繁琐，比如账户表如果把昵称和头像删减掉，我们每次登录就需要多读取一次数据库，并且需要一直关注账户表的缓存同步更新；但如果我们在账户表中保留用户昵称和头像，在登陆验证后直接就可以继续其他业务逻辑了，无需再查询一次数据库。

有些查询往往会因为精简一两个字段就多查一次数据库，并且还要考虑缓存同步问题，实在是得不偿失，因此我们要在“更多的字段”和“更少的职能”之间找到平衡。

数据主要有四种：**实体对象主体、辅助查询表、实体关系、历史数据**

要讲职能拆分清楚，错误做法：将用户来访记录放到缓存，用户来访记录是持续增长的，统计有多少好友、陌生人来访，但它同时保存着和用户是否是好友的标志，一旦用户好友关系变化，这些数据就需要更新，否则里面的好友关系就过时了。

- 历史记录表，不做缓存
- 好友关系，缓存关系？用于统计有几个好友
- 来访统计数字，临时缓存

### 数据实体表

一般会作为主表，一行数据代表一个实体，每个实体都拥有一个独立且唯一的ID作为标识。

此ID对于高并发下的缓存很重要，用户登录后就需要用自己账户的ID直接查找对应的订单、昵称头像和好友列表信息。这种是按照ID直接查找的性能好，适合做长期缓存。

但业务除了这种，还有一些需要通过组合条件查询的，这种不太容易做缓存，很容易出现不一致、数据量不确定导致的性能不稳定等问题，并且如果涉及的数据出现变化，很难通过数据确定同步更新哪些缓存。

这类数据只适合存在关系数据库或提前预置计算好结果放在缓存中直接使用，做定期更新。

除了组合条件查询不好缓存外，像 count() 、sum() 等对数据进行实时计算也有更新不及时的问题，同样只能定期缓存汇总结果，不能频繁查询。所以，我们应该在后续的开发过程中尽量避免使用数据库做计算。

实体数据是我们业务的主要承载体，当我们找到实体主体的时候，就可以根据这个主体在缓存中查到所有和它有关联的数据，来服务用户。现在我们来稍微总结一下，我们整理实体表的核心思路主要有以下几点：精简数据总长度；减少表承担的业务职能；减少统计计算查询；实体数据更适合放在缓存当中；尽量让实体能够通过 ID 或关系方式查找；减少实时条件筛选方式的对外服务。

### 实体辅助表

为了精简数据且方便管理，我们经常会根据不同用途对主表拆分，常见的方式是做纵向表拆分。

行业里也会用一些开源搜索引擎，辅助我们做类似的关系业务查询，比如用 ElasticSearch 做商品检索、用 OpenSearch 做文章检索等。这种可横向扩容的服务能大大降低数据库查询压力，但唯一缺点就是很难实现数据的强一致性，需要人工检测、核对两个系统的数据。实体关系表。ES做数据的复杂查询真的比mysql和oracle快很多，但是如果要更新历史数据，维护数据的一致性，会比较麻烦。

### 实体关系表

在对 1:n 或 m:n 关系的数据做缓存时，我们建议提前预估好可能参与的数据量，防止过大导致缓存缓慢。同时，通常保存这个关系在缓存中会把主体的 ID 作为 key，在 value 内保存多个关联的 ID 来记录这两个数据的关联关系。而对于读取特别频繁的的业务缓存，才会考虑把数据先按关系组织好，然后整体缓存起来，来方便查询和使用。

#### 到底什么样的数据适合做缓存？

一般来说，根据 ID 能够精准匹配的数据实体很适合做缓存；而通过 String、List 或 Set 指令形成的有多条 value 的结构适合做（1:1、1:n、m:n）辅助或关系查询；最后还有一点要注意，虽然 Hash 结构很适合做实体表的属性和状态，但是 Hgetall 指令性能并不好，很容易让缓存卡顿，建议不要这样做。

![](https://raw.githubusercontent.com/67in/blog_images/main/img/202303292230168.png)

### 动作历史表

动作历史数据表记录的是数据实体的动作或状态变化过程，比如用户登陆日志、用户积分消费获取记录等。这类数据会随着时间不断增长，它们一般用于记录、展示最近信息，不建议用在业务的实时统计计算上。

### 总结：

一般来说，数据可分为四类：实体表、实体辅助表、关系表和历史表，而判断是否适合缓存的核心思路主要是以下几点：能够通过 ID 快速匹配的实体，以及通过关系快速查询的数据，适合放在长期缓存当中；通过组合条件筛选统计的数据，也可以放到临时缓存，但是更新有延迟；数据增长量大或者跟设计初衷不一样的表数据，这种不适合、也不建议去做做缓存。
